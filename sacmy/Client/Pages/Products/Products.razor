@page "/Products"
@using sacmy.Client.Components
@using sacmy.Client.Pages.Products.Components
@using sacmy.Client.Services
@using sacmy.Client.Shared.Components.DialogHeader
@using sacmy.Client.Shared.Toast
@using sacmy.Shared.Core
@using sacmy.Shared.ViewModels.BrandViewModel
@using sacmy.Shared.ViewModels.CustomerViewModel
@using sacmy.Shared.ViewModels.LowStockViewModels
@using sacmy.Shared.ViewModels.Products
@using sacmy.Client.Pages.Components
@using sacmy.Client.Components.Dialogs
@using sacmy.Shared.ViewModels.StickNoteViewModel
@inject ProductsService ProductsService
@inject BrandService BrandService
@inject StickyNoteService stickyNoteService
@inject IJSRuntime JS
@inject UserGlobalClass UserGlobal
@inject ToastService ToastService




<div class="container-fluid py-3">
    <div class="row">
        <!-- Brand Selection -->
        <div class="col-12">
            <div class="d-flex align-items-center gap-2">
                <select class="form-select bg-white border rounded-3"
                        style="width: 180px;"
                        @bind="selectedBrandId"
                        @oninput="OnBrandSelected">
                    <option value="">All Brands</option>
                    @if (brands != null)
                    {
                        @foreach (var brand in brands)
                        {
                            <option value="@brand.Id">@brand.NameEn</option>
                        }
                    }
                </select>
                <button class="btn btn-outline-primary btn-sm"
                        @onclick="ShowAddBrandDialog">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>

        <div class="col-xl-9">
            <!-- Product Filters Component -->
            <ProductFilters SearchString="@searchString"
                            SelectedCategory="@SelectedCategory"
                            ShowOnlyInStock="@showOnlyInStock"
                            IsResettingCache="@isResettingCache"
                            Categories="@brandResponse?.Data?.Categories"
                            SearchStringChanged="value => { searchString = value; ApplyFilters(); }"
                            SelectedCategoryChanged="value => { SelectedCategory = value; ApplyFilters(); }"
                            ShowOnlyInStockChanged="value => { showOnlyInStock = value; ApplyFilters(); }"
                            OnFilterChangeCallback="ApplyFilters"
                            OnGeneratePdfCallback="GeneratePDF"
                            OnResetCacheCallback="ResetCache" />

            @if (selectedProductIds.Any())
            {
                <div class="bg-light p-2 rounded-3 shadow-sm mb-3 selection-toolbar">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="me-3 fw-medium">@selectedProductIds.Count products selected</span>
                            <button class="btn btn-link text-decoration-none p-0" @onclick="() => { selectedProductIds.Clear(); StateHasChanged(); }">
                                Clear selection
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-primary" @onclick="ShowCustomizePriceDialog">
                                <i class="bi bi-currency-dollar me-1"></i> Customize Price
                            </button>
                        </div>
                    </div>
                </div>
            }

            @if (isLoading)
            {
                <div class="d-flex justify-content-center my-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            }
            else if (FilteredProducts?.Any() == true)
            {
                <!-- Product List Component -->
                <ProductListView Products="@PaginatedProducts"
                                 AllProductsSelected="@AllProductsSelected"
                                 SelectedProductIds="@selectedProductIds"
                                 ExpandedProductIds="@expandedProductIds"
                                 CurrentPage="@CurrentPage"
                                 PageSize="@PageSize"
                                 TotalItems="@(FilteredProducts?.Count() ?? 0)"
                                 IsUpdating="@isUpdating"
                                 Categories="@brandResponse?.Data?.Categories"
                                 AllProductsSelectedChanged="value => { AllProductsSelected = value; }"
                                 OnProductSelectCallback="SelectProduct"
                                 OnProductSelectionToggleCallback="ToggleProductSelection"
                                 OnToggleExpandCallback="ToggleProductExpand"
                                 OnShowNotesCallback="ShowAllNotes"
                                 OnAddNoteCallback="ShowAddNoteDialog"
                                 OnMonitorProductCallback="ShowMonitorDialog"
                                 OnAdvancedEditCallback="ShowAdvancedEdit"
                                 OnSaveChangesCallback="SaveChanges"
                                 OnPageChangedCallback="NavigateToPage" />
            }
            else
            {
                <div class="alert alert-info">
                    No products found matching your criteria.
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
        </div>

        <div class="col-xl-3">
            <ProductOverviewPanel FilteredProducts="@FilteredProducts" SelectedProductId="@selectedProductIdforPriceChange" />
        </div>
    </div>

    <!-- Progress Modal (Kept in main page since it's using JS interactions) -->
    <div class="modal" id="pdfProgressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 pt-0">
                    <!-- Price Adjustment Modal Content -->
                    <div id="price-adjustment-section">
                        <div class="text-center mb-4">
                            <i class="bi bi-file-pdf text-primary" style="font-size: 2.5rem;"></i>
                            <h5 class="modal-title mt-3">PDF Generation Options</h5>
                            <p class="text-muted small mb-4">Configure range and price adjustment</p>

                            <!-- Range Selection -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Select Range</h6>
                                    <span class="text-muted small">
                                        Total items: <span id="totalItemsCount" class="fw-bold">0</span>
                                    </span>
                                </div>
                                <p class="text-muted small mb-2 text-start">
                                    Maximum 999 items per range
                                </p>
                                <div class="row g-2">
                                    <div class="col">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">From</span>
                                            <input type="number"
                                                   class="form-control"
                                                   id="rangeFrom"
                                                   min="1"
                                                   value="1">
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">To</span>
                                            <input type="number"
                                                   class="form-control"
                                                   id="rangeTo"
                                                   min="1"
                                                   value="999">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hide Prices Option -->
                            <div class="mb-4 text-start">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hidePrices">
                                    <label class="form-check-label" for="hidePrices">
                                        Hide prices in PDF
                                    </label>
                                </div>
                            </div>

                            <!-- Price Adjustment -->
                            <div class="mb-4">
                                <h6 class="text-start mb-2">Price Adjustment</h6>
                                <div class="input-group" style="max-width: 200px;">
                                    <span class="input-group-text bg-light">$</span>
                                    <input type="number"
                                           class="form-control"
                                           id="priceIncrease"
                                           step="0.01"
                                           min="0"
                                           value="0.00"
                                           placeholder="0.00">
                                </div>
                            </div>

                            <button class="btn btn-primary px-4" onclick="startPdfGeneration()">
                                Generate PDF
                            </button>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div id="progress-section" style="display: none;">
                        <div class="text-center">
                            <i class="bi bi-file-pdf text-primary" style="font-size: 2.5rem;"></i>
                            <h5 class="mt-3 mb-2">Generating PDF</h5>

                            <div class="progress my-4" style="height: 10px;">
                                <div class="progress-bar bg-primary"
                                     role="progressbar"
                                     style="width: 0%"
                                     aria-valuenow="0"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between text-muted small mb-2">
                                <span class="progress-count">0 of 0 items</span>
                                <span class="progress-percentage">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals/Dialogs -->
    <StickyNoteDetailsDialog IsVisible="@showNoteDialog"
                             Note="@selectedNote"
                             OnClose="@CloseNoteDialog" />

    <AddStickyNoteDialog IsVisible="@showAddDialog"
                         ProductId="@selectedProductId"
                         OnClose="@CloseAddDialog"
                         OnNoteSaved="@AddNote" />

    <AllNotesDialog IsVisible="@showAllNotesDialog"
                    ProductId="@selectedProductForNotes"
                    Notes="@currentProductNotes"
                    OnClose="@CloseAllNotesDialog"
                    OnNoteSaved="@AddNoteFromTimeline" />

    <StockMonitorDialog IsVisible="@showMonitorDialog"
                        Model="@monitorModel"
                        OnClose="@CloseMonitorDialog"
                        OnSave="@SaveMonitoring" />

    <AddBrandDialog IsVisible="@showAddBrandDialog"
                    Brand="@newBrand"
                    Error="@brandError"
                    IsCreating="@isCreatingBrand"
                    OnClose="@CloseAddBrandDialog"
                    OnSave="@CreateBrand" />

    <AdvancedEditDialog Product="@selectedProduct"
                        IsVisible="@showAdvancedEdit"
                        IsVisibleChanged="(value) => showAdvancedEdit = value"
                        OnSaved="@HandleAdvancedEditSaved"
                        Categories="@brandResponse?.Data?.Categories"
                        Collections="@brandResponse?.Data?.Collections"
                        Brands="@brands" />

    <CustomizePriceDialog IsVisible="@showCustomizePriceDialog"
                          SelectedCount="@selectedProductIds.Count"
                          SelectedProductIds="@selectedProductIds.ToList()"
                          OnClose="CloseCustomizePriceDialog"
                          OnApplyCustomPrice="ApplyCustomPrice" />
</div>

<style>
    /* Selection Toolbar */
    .selection-toolbar {
        animation: fadeIn 0.3s ease-in-out;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(-10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }
</style>

@code {
    private List<BrandViewModel> brands;
    private string selectedBrandId;
    private string selectedProductIdforPriceChange;
    private bool isLoading = true;
    private string searchString = "";
    private string SelectedCategory = "";
    private HashSet<string> expandedProductIds = new();
    private BrandResponse brandResponse;
    private const string PASABHACE_DEFAULT_ID = "63459FB9-37CD-4119-BA73-8E614E5F308B";
    private int CurrentPage = 1;
    private const int PageSize = 10;
    private bool isUpdating = false;
    private string successMessage = null;
    private string errorMessage = null;
    private IJSObjectReference _jsModule;
    private bool showOnlyInStock = false;
    private Product selectedProduct = new Product();
    private bool showAdvancedEdit;
    private GetStickyNoteViewModel selectedNote;
    private bool showNoteDialog = false;
    private bool showAddDialog = false;
    private string newNoteText = "";
    private string selectedProductId;
    private bool showMonitorDialog = false;
    private MonitorProductViewModel monitorModel = new();
    private string selectedProductIdForMonitoring;
    private bool showAllNotesDialog = false;
    private List<GetStickyNoteViewModel> currentProductNotes;
    private string selectedProductForNotes;
    private bool isAddingNote = false;
    private bool showAddBrandDialog = false;
    private bool isCreatingBrand = false;
    private string brandError = "";
    private BrandViewModel newBrand = new();
    private bool isResettingCache = false;
    private bool showCustomizePriceDialog = false;

    // Selection properties
    private HashSet<string> selectedProductIds = new HashSet<string>();
    private bool AllProductsSelected
    {
        get => FilteredProducts.Any() && selectedProductIds.Count == FilteredProducts.Count();
        set
        {
            if (value)
            {
                selectedProductIds = new HashSet<string>(FilteredProducts.Select(p => p.Id));
            }
            else
            {
                selectedProductIds.Clear();
            }
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadBrands();
            await SetDefaultBrandAndLoadProducts();
            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private async Task LoadBrands()
    {
        try
        {
            brands = await BrandService.GetBrandsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading brands: {ex.Message}");
        }
    }

    private async Task SetDefaultBrandAndLoadProducts()
    {
        try
        {
            selectedBrandId = PASABHACE_DEFAULT_ID;
            brandResponse = await ProductsService.GetProductsByBrandAsync(selectedBrandId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching default brand products: {ex.Message}");
        }
    }

    private async Task OnBrandSelected(ChangeEventArgs e)
    {
        try
        {
            selectedBrandId = e.Value.ToString();
            if (!string.IsNullOrEmpty(selectedBrandId))
            {
                isLoading = true;
                brandResponse = await ProductsService.GetProductsByBrandAsync(selectedBrandId);
                isLoading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching products by brand: {ex.Message}");
        }
    }

    private IEnumerable<Product> FilteredProducts =>
        brandResponse?.Data?.Products?
            .Where(p =>
                (string.IsNullOrEmpty(SelectedCategory) || p.CategoryId == SelectedCategory) &&
                (string.IsNullOrEmpty(searchString) ||
                 p.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
                 p.Sku.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
                 p.PatternNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase)) &&
                (!showOnlyInStock || p.Quantity > 0)
            )
            .OrderByDescending(p => p.IsNew)
            .ThenBy(p => p.Name) ?? Enumerable.Empty<Product>();

    private IEnumerable<Product> PaginatedProducts =>
        FilteredProducts
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize);

    private void NavigateToPage(int page)
    {
        var totalPages = (int)Math.Ceiling((FilteredProducts?.Count() ?? 0) / (double)PageSize);

        if (page >= 1 && page <= totalPages)
        {
            CurrentPage = page;
            StateHasChanged();
        }
    }

    private void ApplyFilters()
    {
        // Reset to first page when filters change
        CurrentPage = 1;
        StateHasChanged();
    }

    private async Task GeneratePDF()
    {
        try
        {
            var productsToExport = FilteredProducts?.Select(p => new
            {
                sku = p.Sku,
                patternNumber = p.PatternNumber,
                price = p.Price,
                image = p.Image,
                boxCount = p.BoxCount,
                pieceCount = p.PieceCount
            }).ToList();

            if (productsToExport == null || !productsToExport.Any())
            {
                errorMessage = "No products available to generate PDF.";
                StateHasChanged();
                return;
            }

            // Show modal with price adjustment option
            await JS.InvokeVoidAsync("showPdfModal", productsToExport);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating PDF: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task ShowAdvancedEdit(Product product)
    {
        try
        {
            selectedProduct = product;
            showAdvancedEdit = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error showing advanced edit: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task HandleAdvancedEditSaved()
    {
        showAdvancedEdit = false;
        StateHasChanged();
    }

    private void SelectProduct(string productId)
    {
        selectedProductId = productId;
        selectedProductIdforPriceChange = productId;
        selectedProduct = FilteredProducts.FirstOrDefault(p => p.Id == productId);
        StateHasChanged();
    }

    private void ToggleProductSelection((string productId, bool isChecked) selection)
    {
        if (selection.isChecked)
        {
            selectedProductIds.Add(selection.productId);
        }
        else
        {
            selectedProductIds.Remove(selection.productId);
        }
        StateHasChanged();
    }

    private void ToggleProductExpand(string productId)
    {
        if (expandedProductIds.Contains(productId))
            expandedProductIds.Remove(productId);
        else
            expandedProductIds.Add(productId);

        StateHasChanged();
    }

    private async Task SaveChanges(Product product)
    {
        if (isUpdating) return;
        isUpdating = true;

        try
        {
            var updateModel = new UpdateProductViewModel
                {
                    ProductId = Guid.Parse(product.Id),
                    Name = product.Name,
                    PatternNumber = product.PatternNumber,
                    Price = double.Parse(product.Price.ToString()),
                    CategoryId = product.CategoryId,
                    CollectionId = product.SeriesOrCollectionId,
                    Quantity = product.Quantity,
                    OuterTypeCount = product.BoxCount ?? 0,
                    InnerTypeCount = product.PieceCount ?? 0,
                    Upc = product.Upc,
                    Ean = product.Ean,
                    Points = product.Points,
                    Volume = double.Parse(product.Volume.ToString())
                };

            var response = await ProductsService.UpdateProductAsync(updateModel);

            if (response.Success)
            {
                ToastService.ShowToast(response.Message ?? "Changes saved successfully", "success");
                await LoadBrands();
                await SetDefaultBrandAndLoadProducts();
            }
            else
            {
                ToastService.ShowToast(response.Message ?? "Failed to save changes", "danger");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Error updating product: {ex.Message}", "danger");
        }
        finally
        {
            isUpdating = false;
            ToggleProductExpand(product.Id);
            StateHasChanged();
        }
    }

    private void ShowAllNotes((string productId, List<GetStickyNoteViewModel> notes) data)
    {
        selectedProductForNotes = data.productId;
        currentProductNotes = data.notes;
        showAllNotesDialog = true;
    }

    private void CloseAllNotesDialog()
    {
        showAllNotesDialog = false;
        selectedProductForNotes = null;
        currentProductNotes = null;
        newNoteText = "";
    }

    private void ShowAddNoteDialog(string productId)
    {
        selectedProductId = productId;
        showAddDialog = true;
    }

    private void CloseAddDialog()
    {
        showAddDialog = false;
        newNoteText = "";
        selectedProductId = null;
    }

    private async Task AddNote()
    {
        if (string.IsNullOrWhiteSpace(newNoteText) || string.IsNullOrEmpty(selectedProductId))
            return;

        try
        {
            var model = new AddStickyNoteViewModel
                {
                    TableName = "Products",
                    RecordId = selectedProductId,
                    Note = newNoteText,
                    EmployeeId = UserGlobal.User.Id
                };

            var response = await stickyNoteService.CreateStickyNoteAsync(model);

            if (response.Success)
            {
                ToastService.ShowToast("Note added successfully", "success");
                await LoadBrands();
                CloseAddDialog();
            }
            else
            {
                ToastService.ShowToast(response.Message ?? "Failed to add note", "error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Error adding note: {ex.Message}", "error");
        }
    }

    private async Task AddNoteFromTimeline()
    {
        if (string.IsNullOrWhiteSpace(newNoteText))
        {
            ToastService.ShowToast("Cannot add empty note", "warning");
            return;
        }

        try
        {
            isAddingNote = true;

            var model = new AddStickyNoteViewModel
                {
                    TableName = "Products",
                    RecordId = selectedProductForNotes,
                    Note = newNoteText,
                    EmployeeId = UserGlobal.User.Id
                };

            var response = await stickyNoteService.CreateStickyNoteAsync(model);

            if (response.Success)
            {
                // Refresh the product data
                await LoadBrands();

                // Get the updated product data
                brandResponse = await ProductsService.GetProductsByBrandAsync(selectedBrandId);

                // Find the current product and update the notes list
                var updatedProduct = brandResponse?.Data?.Products?
                    .FirstOrDefault(p => p.Id == selectedProductForNotes);

                if (updatedProduct != null)
                {
                    currentProductNotes = updatedProduct.StickyNotes;
                    StateHasChanged();
                }

                newNoteText = ""; // Clear the input
                ToastService.ShowToast("Note added successfully", "success");
            }
            else
            {
                ToastService.ShowToast(response.Message ?? "Failed to add note", "error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Error adding note: {ex.Message}", "error");
        }
        finally
        {
            isAddingNote = false;
            StateHasChanged();
        }
    }

    private void ShowNoteDetails(GetStickyNoteViewModel note)
    {
        selectedNote = note;
        showNoteDialog = true;
    }

    private void CloseNoteDialog()
    {
        showNoteDialog = false;
        selectedNote = null;
    }

    private void ShowMonitorDialog(string productId)
    {
        selectedProductIdForMonitoring = productId;
        monitorModel = new MonitorProductViewModel
            {
                ProductID = Guid.Parse(productId),
                EmployeeID = UserGlobal.User.Id,
                Threshold = 10 // Default suggested threshold
            };
        showMonitorDialog = true;
    }

    private void CloseMonitorDialog()
    {
        showMonitorDialog = false;
        selectedProductIdForMonitoring = null;
        monitorModel = new();
    }

    private async Task SaveMonitoring()
    {
        if (monitorModel.Threshold <= 0)
        {
            ToastService.ShowToast("Threshold must be greater than 0", "warning");
            return;
        }

        try
        {
            var response = await ProductsService.MonitorProductAsync(monitorModel);

            if (response.Success)
            {
                ToastService.ShowToast("Stock alert threshold set successfully", "success");
                CloseMonitorDialog();
            }
            else
            {
                ToastService.ShowToast(response.Message ?? "Failed to set stock alert threshold", "error");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Error setting stock alert threshold: {ex.Message}", "error");
        }
    }

    private async Task ResetCache()
    {
        try
        {
            isResettingCache = true;
            StateHasChanged();

            await ProductsService.ResetCacheAsync();

            // Refresh data after cache clear
            await SetDefaultBrandAndLoadProducts();

            ToastService.ShowToast("Cache reset and data refreshed successfully", "success");
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Error resetting cache: {ex.Message}", "error");
        }
        finally
        {
            isResettingCache = false;
            StateHasChanged();
        }
    }

    private void ShowAddBrandDialog()
    {
        showAddBrandDialog = true;
        newBrand = new BrandViewModel();
        brandError = "";
    }

    private void CloseAddBrandDialog()
    {
        showAddBrandDialog = false;
        newBrand = new BrandViewModel();
        brandError = "";
    }

    private async Task CreateBrand()
    {
        if (string.IsNullOrWhiteSpace(newBrand.NameEn) ||
            string.IsNullOrWhiteSpace(newBrand.NameAr) ||
            string.IsNullOrWhiteSpace(newBrand.Image))
        {
            brandError = "Please fill in all fields";
            return;
        }

        try
        {
            isCreatingBrand = true;
            brandError = "";

            var response = await BrandService.CreateBrandAsync(newBrand);

            if (response.IsSuccessStatusCode)
            {
                await LoadBrands(); // Refresh the brands list
                ToastService.ShowToast("Brand created successfully", "success");
                CloseAddBrandDialog();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                brandError = $"Failed to create brand: {error}";
            }
        }
        catch (Exception ex)
        {
            brandError = $"Error creating brand: {ex.Message}";
        }
        finally
        {
            isCreatingBrand = false;
            StateHasChanged();
        }
    }

    private void ShowCustomizePriceDialog()
    {
        showCustomizePriceDialog = true;
    }

    private void CloseCustomizePriceDialog()
    {
        showCustomizePriceDialog = false;
        StateHasChanged();
    }

    private async Task ApplyCustomPrice(CustomPriceViewModel model)
    {
        try
        {
            ToastService.ShowToast($"Custom pricing applied for {selectedProductIds.Count} products for customer {model.CustomerName}", "success");

            // Optionally, refresh product data here
            // await LoadBrands();
            // await SetDefaultBrandAndLoadProducts();

            showCustomizePriceDialog = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ToastService.ShowToast($"Error applying custom prices: {ex.Message}", "error");
        }
    }
}

