@page "/Products"
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@using sacmy.Shared.ViewModels.ProductsViewModel
@using static MudBlazor.Icons.Material
@using Microsoft.AspNetCore.Components.Forms
@using static MudBlazor.CategoryTypes


<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadProducts">Load Products</MudButton>
<MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="GeneratePDF">Generate PDF</MudButton>

<!-- Bootstrap Modal for Progress Bar -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Generating PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%;" aria-valuenow="0"
                         aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<MudDataGrid T="GetProductsViewModel" Items="@currentPageProducts" Dense="true" Bordered="true">
    <Columns>
        <PropertyColumn Property="x => x.PatternNumber" />
        <PropertyColumn Property="x => x.Sku" />
        <PropertyColumn Property="x => x.BrandName" />
        <PropertyColumn Property="x => x.CollectionName" />
        <PropertyColumn Property="x => x.BoxCount" />
        <PropertyColumn Property="x => x.PieceCount" />
    </Columns>
</MudDataGrid>

<MudPagination Count="@totalPages" SelectedChanged="OnPageChanged" Class="mt-4" />

@code {
    private List<GetProductsViewModel> currentPageProducts = new();
    private int currentPage = 1;
    private int totalPages = 1;
    private const int PageSize = 500;

    private async Task LoadProducts()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ProductsPaginatedResponse<GetProductsViewModel>>($"api/product?PageNumber={currentPage}&PageSize={PageSize}");
            if (response != null)
            {
                currentPageProducts = response.Items;
                totalPages = response.TotalPages;
                Snackbar.Add("Products Loaded Successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading products: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadProducts();
    }

    private async Task GeneratePDF()
    {
        // Call the JavaScript function to generate the PDF
        await JS.InvokeVoidAsync("generatePDF", currentPageProducts);
    }
}





